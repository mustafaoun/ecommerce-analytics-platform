#!/usr/bin/env python3
"""
Sync Metabase schema and recreate saved questions.

SETUP:
1. Copy this file to sync_metabase.py
2. Update METABASE_API, username, and password with your credentials
3. Run: python sync_metabase.py
"""
import requests
import time

METABASE_API = "http://localhost:3000/api"

session = requests.Session()

# Login with your Metabase credentials
resp = session.post(f"{METABASE_API}/session", json={"username": "admin@ecommerce.com", "password": "YOUR_PASSWORD_HERE"})
token = resp.json().get('id')
session.headers['X-Metabase-Session'] = token
print("âœ… Logged in\n")

# Trigger schema sync for database 2
print("ðŸ”„ Syncing Metabase schema with database...")
resp = session.post(f"{METABASE_API}/database/2/sync_schema")
print(f"   Response: {resp.status_code}")

time.sleep(3)

# Recreate saved questions with correct database reference
questions = [
    ("Total Revenue", "SELECT SUM(total_amount)::numeric(12,2) as total_revenue FROM orders WHERE status = 'completed'"),
    ("Daily Revenue", "SELECT DATE(order_date) as date, SUM(total_amount)::numeric(12,2) as revenue FROM orders WHERE status = 'completed' GROUP BY DATE(order_date) ORDER BY date DESC LIMIT 30"),
    ("Top Products", "SELECT p.name, SUM(oi.quantity * oi.price_at_time)::numeric(12,2) as revenue FROM order_items oi JOIN products p ON oi.product_id = p.product_id GROUP BY p.product_id, p.name ORDER BY revenue DESC LIMIT 10"),
    ("Total Customers", "SELECT COUNT(DISTINCT user_id) as total_customers FROM users"),
    ("Customer Geography", "SELECT country, COUNT(*) as count FROM users GROUP BY country ORDER BY count DESC LIMIT 15"),
]

for question_name, sql in questions:
    payload = {
        "name": question_name,
        "description": f"Auto-generated question: {question_name}",
        "database_id": 2,
        "type": "query",
        "query": {
            "source-table": None,
            "native": {
                "query": sql
            }
        }
    }
    resp = session.post(f"{METABASE_API}/card", json=payload)
    card_id = resp.json().get('id')
    print(f"âœ… Created question: {question_name} (ID: {card_id})")

print("\nâœ… All saved questions created!")
